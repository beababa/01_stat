---
title: "Variance"
output:
  html_document:
    number_sections: yes
    toc: yes
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Intro :  rappels divers

## Théorie

- le khi2, la régression, et la variance

- démarche générale 

Avec le khi2, on a vu surtout le test et sa significativité.

Avec la régression, on a abordé l'intensité et le coefficient de détermination.

Avec la variance, nous allons aborder test, significativité et intensité.

## Outils

- xls ou csv

- libre office ou R

# Donnée et objet de l'exercice

Suite à l'examen, on a 3 séries de communes, dans Est Ensemble, en Ile de France et sur la France.
On va tester s'il y a une répartition spatiale spécifique du logement social dans chacun de ces ensembles spatiaux.

La variance est en effet très souvent utilisée en géographie pour tester des groupements spatiaux.


## Hypothèse 

D'après vos résultats, c'est le rapport entre les différents types de logement social qui serait spécifique.
Il y a moins de logements sociaux intermédiaires (les "moins pauvres") ailleurs qu'à Bondy. Y-a-t-il une spécificité en Ile de France ?

R va nous permettre de mettre en place la donnée d'exemple.

## Préparer la donnée

### Que faut-il faire ?

Lire les fichiers 
Calculer le nombre de logements intermédiaires rapportés au total des logements sociaux.
Enregistrer ce rapport dans un fichier


### Remarques sur R

- opérateur d'assignation

- les accolades

- la complétion avec tabulation


Parcours du script et exercice moodle pour voir si c'est compris.

### Le script


On regroupe toutes les données en un seul fichier

```{r, eval=FALSE}
fic <- list.files ("data/", "^ee|^fr|^idf")
data <- NULL
for (i in 1:length(fic)){
  tmp <- read.csv(paste0("data/", fic [i]), fileEncoding = "UTF-8")
  zone <- substring(fic [i],0,2)
  tmp <- cbind(zone, tmp)
  data <- rbind(data, tmp)
}
data <- data [, c("LIBCOM", "zone", "FINANcode")]
write.csv(data,"data/total.csv", fileEncoding = "UTF-8")
```

Le fichier total fait plus de 113 M lignes.

On calcule le rapport entre le logement intermédiaire pour chaque ville.

```{r}
# lecture du fichier. Quelle remarque faire ?
data <-  read.csv("data/total.csv", fileEncoding = "UTF-8")
# concaténation zone et nom ville
data$loc <- paste0(data$zone,"_", data$LIBCOM)
str(data)
# dénombrement
tab <- table(data$loc,data$FINANcode)
# on met les marges
tab <- addmargins(tab,2)
# on affiche
knitr::kable(tab)
# calcul du rapport
rapport <- tab [,1]/ tab[,4]
```

On reconstitue la donnée sur laquelle on va travailler, c'est à dire un tableau
avec zone, ville et le rapport logement intermédiaire et logement total.

```{r}
zone <- substring(names(rapport), 1,2)
ville <- substring(names(rapport),4,25)
data <- data.frame(ville, zone, rapport)
# On regarde la tête du fichier
head(data)
```


# Représentation graphique

La boite à moustaches permet de comparer rapidement des distributions.
Les moustaches montrent les 1ers et 9e déciles. Les limites des boites correspondent au 1e et 3e quartile
Le trait indique la médiane.
Les valeurs aberrantes sont les points isolés.


```{r}
boxplot(data$rapport~data$zone)
# avec un peu de présentation
# On multiplie  par 100 le rapport pour avoir un %
data$rapport <- data$rapport * 100
boxplot(data$rapport~data$zone, xlab ="Zone", ylab="% logement intermédiaire",
        col=rainbow(8))
moyenne <- tapply(data$rapport, data$zone, mean)
points(moyenne, pch = 8,  col="black", cex = 2)
pt <- data [data$zone == "fr" & data$rapport > 600,]
```

Ce graphique permet de comparer les 3 séries.
Les variations entre les groupes sont-elles plus importantes que les 
variations au sein des groupes eux-mêmes ?
A priori, en île de France, l'amplitude est très étendue et la distribution est plus symétrique que les 2 premières (la médiane est quasiment au centre de la boite).
Est Ensemble et la France s'opposent par contre assez bien : il y a beaucoup de communes avec logements intermédiaires, alors qu'en France, il n'y en a moins.


Il existe une valeur aberrante en France

```{r}
data [data$zone == "fr",]
```

La commune de Vaulx-en-Velin possède une part très importante de logement intermédiaire. 


# La variance


## Rappel

Pour mémoire, la variance est le carré de la moyenne des écarts à la moyenne.

Dans le tableur, nous aurions fait une série de tableaux de calcul autour des 
écarts à la moyennes (en mettant des carrés). Dans r, c'est une formule var.

```{r}
var(data$rapport)
# Variance pour chaque zone, on utilise un tapply
tapply(data$rapport, data$zone,var)
# verif pour le cas d'Est Ensemble par exemple
dataSel <- data [data$zone == 'ee',]
mean((dataSel$rapport - mean(dataSel$rapport))^2)
var(dataSel$rapport)
```

Le résultat est légèrement différent, car le logiciel pondère la variance en soustrayant 1 à l'effectif. Plus la série est grande, moins cela a d'importance.
A notre niveau, nous appelons variation la grandeur donnée par R.

## Analyse de la variation / variance

La variation est une quantité qui se décompose en :

- les variations à l'intérieur de chaque groupe (variation intra groupe)

- les variations entre les groupes (variation inter groupe)

La variation totale est la somme des deux. La significativité et l'intensité sont calculées avec ces trois grandeurs.

significativité = rapport inter / intra

intensité = rapport inter / total

### La formule ANOVA dans R

ANalyse Ordinaire de la VAriance (= variation)

Sous R, il suffit de lancer une formule.

```{r}
# transformation en variable de catégorie
data$zone <- as.factor(data$zone)
modele <- lm (rapport ~ zone, data = data)
anova(modele)
```


Sum Sq = la somme des carrés des écarts (SCE)

Mean Sq =  la moyenne des carrés des écarts, c'est la variation.

La première ligne c'est pour la variation inter-groupe , la deuxième c'est pour l'intérieur des groupes (l'intra)

Que dire ce ces chiffres ?

Comme pour le khi2, on peut faire un test et calculer l'intensité.

### Significativité

F value = Test de Fisher, c'est le test de significativité pour la variation.

Le test est mesuré par le rapport entre la variation intergroupe et la variation intragroupe (avec les degrés de liberté).

Si ce rapport est élevé, cela signifie que la variation intergroupe est importante relativement à la variation intra, donc qu'il y a une vraie différence entre les écarts à la moyenne des groupes.

Concernant les degré de liberté pour les données intra, on prend tous les effectifs et on enlève le nombre de zone (cf les 2 chiffres df)


#### Comme pour le khi2, observé et théorique

Comme pour le khi2, on compare à un test obtenu par le hasard (donc une table).

![](img/fisher.jpg)
F calculé

```{r}
Ftable <- qf(p=.05, df1=2, df2=20, lower.tail=FALSE)
Fcalcule <- 28 / 14
```

Le F théorique est supérieur au F calculé pour un risque de 5 %

Il y a indépendance entre les zones et la part de logement intermédiaire.

### Avec R, importance de la p-value

Le chiffre le plus rapide à analyser, c'est la p-value, il indique la taille de la différence entre les moyennes des 3 groupes.

Plus il est petit, plus il y a de différence, plus il est gros, plus les écarts aux moyennes se ressemblent et donc l'hypothèse d'indépendance peut être rejetée.

C'est la même logique que pour le khi2 (cf exemple khi2 dans l'introduction aux bivariées). 

Dans notre cas, la pvalue indique un risque de 17 %. Concrètement, il faudrait aller chercher la table du risque à 17 % de Fisher.

```{r}
qf(p=.17, df1=2, df2=20, lower.tail=FALSE)
```


On a 17 chances sur 100 de se tromper si on rejette l'indépendance, c'est beaucoup.

Les 3 zonages ne correspondant pas à une répartition spécifique du logement intermédiaire. 

### Intensité

On mesure quand même l'intensité, la proportion de la variation expliquée par les modalités dans la variation totale (entre 0 et 1)

variation intergroupe / variation totale


```{r}
28/(28 +14)
```

L'intensité est forte, plus de 66 % de la variation est expliquée par la structure des zones.
Attention, comme le test a été rejeté avec un risque d'erreur très fort, il faut tout de suite relativiser l'intensité.


```{r, echo=FALSE, eval=FALSE}
note <- read.csv("data/noteExamen.csv")
summary(note$NOTE)
par(mfrow = c(2,1))
boxplot(note$NOTE~note$GROUPE)
modele <- lm (NOTE ~ GROUPE, data = note)
anova(modele)
45/ (45 +15)
```


```{r, echo=FALSE, eval=FALSE}
note <- read.csv("data/noteDSTsimplifie.csv", fileEncoding = "UTF-8")
summary(note$note)
boxplot(note$note~note$groupe)
modele <- lm (note ~ groupe, data = note)
anova(modele)
65/(65+12)
```


