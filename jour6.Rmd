---
title: "Variance"
output:
  html_document:
    number_sections: yes
    toc: yes
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Intro :  rappels divers

## Théorie

- le khi2, la régression, et la variance
- démarche générale (attention à part le khi2, on est passé vite sur les tests)




## Outils

- xls ou csv
- libre office ou R

# Donnée et objet de l'exercice

Suite à l'examen, on a 3 séries de communes, dans Est Ensemble, en Ile de France et sur la France.
On va tester s'il y a une répartition spatiale spécifique du logement social dans chacun de ces ensembles spatiaux.

La variance est en effet très souvent utilisée en géographie pour tester des groupements spatiaux.


## Hypothèse 

D'après vos résultats, c'est le rapport entre les différents types de logement social qui serait spécifique.
Il y a moins de logements sociaux intermédiaires (les "moins pauvres") ailleurs qu'à Bondy. Y-a-t-il une spécificité en Ile de France ?

R va nous permettre de mettre en place la donnée d'exemple.

## Préparer la donnée

### Que faut-il faire ?

Lire les fichiers 
Calculer le nombre de logements intermédiaires rapportés au total des logements sociaux.
Enregistrer ce rapport dans un fichier


### Remarques sur R

- opérateur d'assignation

- les accolades

- la complétion avec tabulation


Parcours du script et exercice moodle pour voir si c'est compris.

### Le script


On regroupe toutes les données en un seul fichier

```{r, eval=FALSE}
fic <- list.files ("data/", "^ee|^fr|^idf")
data <- NULL
for (i in 1:length(fic)){
  tmp <- read.csv(paste0("data/", fic [i]), fileEncoding = "UTF-8")
  zone <- substring(fic [i],0,2)
  tmp <- cbind(zone, tmp)
  data <- rbind(data, tmp)
}
data <- data [, c("LIBCOM", "zone", "FINANcode")]
write.csv(data,"data/total.csv", fileEncoding = "UTF-8")
```

Le fichier total fait plus de 113 M lignes.

On calcule le rapport entre le logement intermédiaire pour chaque ville.

```{r}
# lecture du fichier. Quelle remarque faire ?
data <-  read.csv("data/total.csv", fileEncoding = "UTF-8")
# concaténation zone et nom ville
data$loc <- paste0(data$zone,"_", data$LIBCOM)
str(data)
# dénombrement
tab <- table(data$loc,data$FINANcode)
# on met les marges
tab <- addmargins(tab,2)
# on affiche
knitr::kable(tab)
```



# Représentation graphique

La boite à moustaches permet de comparer rapidement des distributions.


```{r}
rapport <- tab [,1]/ tab[,4]
zone <- substring(names(rapport), 1,2)
ville <- substring(names(rapport),4,25)
data <- data.frame(ville, zone, rapport)
data
boxplot(data$rapport~data$zone)
# avec un peu de présentation
# On multiplie  par 100 le rapport pour avoir un %
data$rapport <- data$rapport * 100
boxplot(data$rapport~data$zone, xlab ="Zone", ylab="% logement intermédiaire",
        col=rainbow(8))
```

Faire le commentaire avec les étudiants (exercice moodle)

# La variance


## Rappel

Pour mémoire, la variance est le carré de la somme des écarts à la moyenne.

Dans le tableur, nous aurions fait une série de tableaux de calcul autour des 
écarts à la moyennes (en mettant des carrés).

```{r}
tapply(data$rapport, data$zone,var)
# verif pour le cas du 77 par exemple
dataSel <- data [data$zone == 'ee',]
mean((dataSel$rapport - mean(dataSel$rapport))^2)
```

## Analyse de la variance

La variation est une quantité qui se décompose en :

- les variations à l'intérieur de chaque groupe (variation intra groupe)

- les variations entre les groupes (variation inter groupe)

### La formule ANOVA dans R

Sous R, il suffit de lancer une formule.

```{r}
# transformation en variable de catégorie
data$zone <- as.factor(data$zone)
modele <- lm (rapport ~ zone, data = data)
anova(modele)
```


Sum Sq = la somme des carrés des écarts (SCE)

Mean Sq =  la moyenne des carrés des écarts, c'est la variance.

La première ligne c'est pour la variation inter-groupe , la deuxième c'est pour l'intérieur des groupes (l'intra)



Comme pour le khi2, on peut faire un test et calculer l'intensité.

### Significativité

F value = Test de Fisher, c'est le test de significativité pour la variance.

Le test est mesuré par le rapport entre la variance intergroupe et la variance intragroupe (avec les degrés de liberté).

Concernant les degré de liberté pour les données intra, on prend tous les effectifs et on enlève le nombre de zone (cf les 2 chiffres df)

Comme pour le khi2, on compare à un test obtenu par le hasard (donc une table).
La relation est significative avec un risque d'erreur de 10 %. 
Il n'y a pas d'indépendance entre les zones et la part de logement intermédiaire, mais le risque d'erreur est important.


### Intensité

On mesure l'intensité, la proportion de la variation expliquée par les modalités
dans la variation totale (entre 0 et 1)

variation intergroupe / variation totale


```{r}
28/(28 +14)
```

L'intensité est forte, plus de 66 % de la variation est expliquée par la structure
des zones.



```{r, echo=FALSE, eval=FALSE}
note <- read.csv("data/noteExamen.csv")
table(note$GROUPE, note$NOTE)
summary(note$NOTE)
boxplot(note$NOTE~note$GROUPE)
modele <- lm (NOTE ~ GROUPE, data = note)
anova(modele)
```





