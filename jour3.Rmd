---
title: "Statistiques bi variées - khi 2"
output:
  html_document:
    number_sections: yes
    toc: yes
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(eval = FALSE)
```

# Déroulement

## Données d'exemple


hypothèse : relation entre les bv et les candidats


Deux distributions de variables de catégorie.

## Différentes étapes

- Tableau de contingence

- calcul du khi2

- comparaison avec le khi2 théorique


# Tableau de contingence

Au sens anglais du terme, *ce qui peut exister*


## Création

Utiliser l'outil de table dynamique (dans le menu données) pour le créer

Résultat attendu :

![](img/tcd.png)



## Analyse d'un tableau de contingence

- Il faut présenter les sources, la structure et le contenu du tableau.

- Lister les questions susceptibles d'être posées, notamment en étudiant les fréquences conditionnelles


### Format conditionnel

![](img/formatConditionnel.png)

Cet outil est-il utile ici ?

### Fréquences conditionnelles en ligne et colonne

Pour pouvoir comparer les bureaux de vote, chaque groupe est ramené à une même base
égale à 100.


savoir-faire tableur

- Objectif : saisir une seule cellule et étendre la formule.
quelle élément fixer, ligne ou colonne ?

- utilisation du %

![](img/frequenceLG.png)

Analyse après avoir mis le format conditionnel.

- répartition des candidats puis lorsque ramené à une base 100, on peut comparer entre les zones.

- les écarts à la moyenne par candidat sont plus parlants

![](img/ecMoyenne.png)

Qu'apporterait une étude des fréquences conditionnelles en colonnes ?

# Tableau de contingence : correction

## Manipulation du tableau

Il fallait travailler sur les élections 2022. 
Le tableau est présenté en longueur.

Pour pouvoir obtenir un tableau de contingence :

- Récupérer le nom de chaque candidat avec une formule


![](img/continRecup.png)
- faire une recopie incrémentée sur la droite

- transposer le tableau et faire une copie spéciale valeurs uniquement (CTRL + MAJ + V)

- poser un filtre et récupérer uniquement les noms des candidats

![](img/continFiltre.png)

- ne pas oublier de faire un copier - coller du tableau final en transposant

## Correction rapide

### Description de la donnée

Il s'agit des résultats de la présidentielle sur 2022 à Bondy (chiffres du ministère de l'intérieur via data.gouv.fr)

La donnée comporte 2 variables :

- les 32 bureaux de vote
-  les 12 candidats

### Graphique

![](img/continGraphique.png)
Remarquer le titre

au niveau de la présentation des séries, la boite de dialogue *plages de données* permet de classer les séries

![](img/continEtik.png)

### Analyse

Sur les 12 candidats, 3 arrivent en tête dans tous les bureaux avec cependant un 
vote majoritaire pour Mélenchon dans l'échantillon des 4 bureaux. Les voies se répartissent de manière quasiment homogène sur les 9 autres candidats.
Même si les bureaux restent différents, les répartitions des votes se ressemblent. Les différences entre bureaux étaient plus marquées en 2002.


### Observations sur les villes choisies


```{r}
data <- st_read("data/geo.gpkg", "data2022")
ind <- grep("^Voix", names(data))
data <- data [,c(1:4,ind)]
nb <-length(unique(data$INSEE_COM))
cog <-unique(data$INSEE_COM)
i <- 2
for (i in 1:nb) {
  tmp <- data [data$INSEE_COM == cog [i], ]
  tmp <- st_drop_geometry(tmp)
  apply(tmp, 1, sum)
}
```



# Khi2 : un exemple sur un dé truqué

Le dé est-il truqué ?

```{r}
face <- seq(1,6)
effectif <- c(15,7,4,11, 6, 17)
total <-  sum(effectif)
knitr::kable(data.frame(face,effectif))
```

Le nombre total de lancers est de 60.

## Hypothèse d'indépendance

hypothèse H0 : le dé n'est pas truqué (il y a indépendance entre la face et le
nombre de fois où elle sort)

## Effectifs théoriques

Sur le total des lancers (60), chaque face aurait pû sortir 10 fois.

```{r}
effectifThéorique <- rep (10,6)
df <- data.frame(face, effectif, effectifThéorique)
knitr::kable(df)
```

## Calcul du khi2

distance entre effectifs théoriques et observés

Elle se mesure avec le khi2

On calcule l'écart, puis le carré de cet écart et on pondère par l'effectif théorique.

```{r, echo = T}
(ecart <- df$effectif - df$effectifThéorique)
(distance <-  ecart^2)
(relatif <- distance / df$effectifThéorique)
(khi2 <- sum(relatif))
```

## Test du khi2

### Paramètres du test

- degré de liberté : 5

C'est le nombre de valeurs possibles -1 (car on peut déterminer la 6e valeur à partir des 5 autres)

- Pour un risque à 0,05 (5 chances sur 100 de se tromper)

### Résultat

Lecture dans la table du khi2

![](img/khi2table.png)
le khi2 théorique est de 11,7, il est donc inférieur au khi2 observé.

Quand le khi2 théorique est inférieur, le test est rejeté.

Le test est rejeté avec un risque de 5 %

Donc, le dé est truqué.


# Mise en pratique sur les résultats des votes 2002





## Ennoncer l'hypothèse H0

La répartition des votes entre les différents candidats est indépendant du bureau de vote.

## Effectif théorique

La première case reçoit la formule :

- (total lg / total) * total colonne

C'est ce qu'on appelle également le produit des marges

![](img/effectifTheorique.png)



## Ecarts entre observés et théoriques

Que signifie une valeur zéro ?

Utiliser la notion

- sur représentation / sous représentation


![](img/ecartsTableauComplet.png)

Sur les bureaux 1 et 2, on observe une sur-représentation de Bayrou et une sous-représentation
de Taubira. (en principe, les bureaux 1 et 2 sont plutôt au centre ville)


## Le Khi2 

Le khi2 va permettre de valider le rejet de l'hypothèse d'indépendance.

rappel : métrique euclidienne plutôt que les valeurs absolues on utilise les carrés


### Le Khi2 partiel

On met les écarts rapportés à la valeur théorique d'indépendance au carré.
Puis on divise par l'effectif théorique.



![](img/khi2partiel.png)

### Le Khi2


Le total de tous les khi2 partiels

![](img/khi2partiel.png)






C'est le total des khi2 partiels (dans notre exemple 768)


![](img/khi2Total.png)

On définit :

- degré de liberté
lg -1 * col -1

16 candidats et 17 bureaux


- risque 1, 5 et 10 %

Sur internet, dans n'importe quelle table, on cherche les valeurs correspondantes.

https://jeanpaullaurent.fr/media/docetud/table_khi2_complete.pdf

Comme le nombre de degrés de liberté est important, on peut aussi utiliser la formule du tableur

![](img/khi2Test.png)


### Rejet de H0 ou pas


HO hypothèse d'indépendance. son rejet implique qu'il y a une relation.

Les variables bureau de vote et candidats ont une relation avec une marge d'erreur très faible puisque le khi2 augmente quand le risque d'erreur baisse.

Les logiciels de stats proposent le risque limite, la valeur de bascule entre le rejet et l'acceptation de l'hypothèse nulle.


# Pourquoi le khi2 ?

## Les fréquences conditionnelles suffisent-t-elles ?

Comparaison des 2 tableaux

Fréquence conditionnelle en ligne


![](img/tabFreqLg.png)

![](img/tabObsTheo.png)

Estimation des écarts fondés sur la pondération des masses

## Le khi2 met en évidence les variations faibles autour de la moyenne

A partir de quand le khi2 devient inférieur ?

Si on prend les résultats de l'élection 2022 où il apparaît que le vote pivot est celui de Mélenchon, le calcul du khi2





```{r}
tab <- read.table("data/tabBondy2022.csv", row.names = 1, header = T, sep = ",")
tab
(test <-chisq.test(tab))
# On supprime le vote Mélenchon
names(tab)
tab2 <- tab [-c(7),]
chisq.test(tab2)
```

Le khi2 diminue légèrement, mais reste largement au dessus du khi2 théorique (environ 560)

## Et en carto...

Carte des contributions au khi2


```{r}
names(test)
chi2partiel <- round(((test$observed - test$expected)^2 / test$expected),0)
chi2partielSomme <- apply(chi2partiel, 1,sum)
chi2partielFreq <- chi2partielSomme/ sum(chi2partielSomme)
hist(chi2partielFreq*100, main = "Distribution des khi2 partiels (%)")
```

Beaucoup de petits khi2 (correspond aux petits candidats)

```{r}
df <- data.frame(bv = names(chi2partielFreq),
                 contrib = chi2partielFreq*100, row.names = NULL
                 )
library(sf)
library(mapsf)
st_layers("data/vote.gpkg")
bv <- st_read("data/vote.gpkg", "bureauPolyZone")
jointure <- merge(bv, df, by.x ="numBureau", by.y="bv")
#jointure$num <- rownames(jointure)
mf_init(bv)
mf_map(jointure, type = "choro", border = "antiquewhite2", var = "contrib", leg_val_rnd = 0,add = T)
mf_label(jointure, var = "numBureau", overlap = FALSE, col= "white",bg ="black", halo = T, cex = 0.8)
mf_layout("Votes par bureau 2022 : contribution au chi2", credits = "data.gouv")
```

Cette carte permet de commencer à classifier les bureaux de vote par rapport à un modèle d'indépendance, une répartition des votes type.

Elle permet de situer précisemment là où l'élection s'est jouée dans les bureaux 5, 24, 2, 15, 29,30

Ce qui est intéressant ici est que ces bureaux sont situés sur l'ensemble du 
territoire de la commune.







