---
title: "Statistiques bi variées - khi 2"
output:
  html_document:
    number_sections: yes
    toc: yes
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Déroulement

## Données d'exemple


hypothèse : relation entre les secteurs géographiques / les résidences et les types d'appartements (du studio au plus de 5 pièces)


Deux distributions connues par classe quelque soit la nature des modalités.

## Différentes étapes

- Tableau de contingence

- calcul du khi2

- comparaison avec le khi2 théorique


# Exploration des données

## Discrétisation des données

Afin de vraiment comprendre, on saisit des modalités différentes : à votre avis comment va-t-on les classer ?

Attention, valeur plancher 5



```{r, echo=FALSE}
library(sf)
zone <- st_read("data/logement.gpkg", "quartiersBailleurs")
rpls <- st_read("data/logement.gpkg", "RPLS")
table(rpls$NBPIECE, useNA = "always")
barplot(table(rpls$NBPIECE, useNA = "always"))
#table(rpls$FINAN, useNA = "always")
# recodification
FINAN <- as.integer(names(table(rpls$FINAN)))
equiv <- "moins pauvres"
code <- data.frame(FINAN, equiv)
choix <- c("très pauvres", "pauvres", "moins pauvres")
code$equiv [ code$FINAN < 13 ] <- choix [1]
code$equiv [ code$FINAN > 48 | code$FINAN == 13] <- choix [2]
jointure1 <- merge  (rpls, code, by = "FINAN")
#table(jointure$equiv)
# pour nb pièces
NBPIECE <-  as.integer(names(table(rpls$NBPIECE)))
taille <- "moyen"
code <- data.frame(NBPIECE, taille)
code$taille [ code$NBPIECE < 3 ] <- "petit"
code$taille [ code$NBPIECE > 4] <- "grand"
jointure2 <- merge  (rpls, code, by = "NBPIECE")
# zones
inter <- st_intersection(jointure2, zone)
rplsPieceZone <- inter [, c("taille", "NOM_IRIS"), drop = T]
write.csv(rplsPieceZone, "data/rplsPieceZone.csv", fileEncoding = "UTF-8")
inter <- st_intersection(jointure1, zone)
rplsTypeZone <- inter [, c("equiv", "NOM_IRIS"), drop = T]
write.csv(rplsTypeZone, "data/rplsTypeZone.csv", fileEncoding = "UTF-8")
#table(rplsTypeZone$equiv,rplsTypeZone$NOM_IRIS)
```

## Cartographies de base


### Les points logements

```{r, echo=FALSE}
library(mapsf)
mf_map(zone)
mf_map(jointure2, type = "typo", var = "taille", add = T)
mf_layout("Taille appartement bailleur social", credits = "RPLS2019")
```


Quel est le problème de cette cartographie ?


```{r}
zone <- st_read("data/logement.gpkg", "quartiersBailleurs")
```

## Carte des zones

```{r}
mf_map(zone, type = "typo", var = "NOM_IRIS")
mf_layout("Zones inventaire bailleurs sociaux", credits = "sources internes, Bondy, 2013")
```


# Tableau de contingence

Au sens anglais du terme, *ce qui peut exister*


## Création

Utiliser l'outil de table dynamique (dans le menu données) pour le créer

Résultat attendu :

```{r}
data <- read.csv("data/rplsPieceZone.csv", fileEncoding = "UTF-8")
tab <- table(data$NOM_IRIS, data$taille)
knitr::kable(addmargins(tab))
```



## Analyse d'un tableau de contingence

- Il faut présenter les sources, la structure et le contenu du tableau.

- Lister les questions susceptibles d'être posées, notamment en étudiant les fréquences conditionnelles


### Format conditionnel

![](img/formatConditionnel.png)
Cet outil est-il utile ici ?

### Fréquences conditionnelles en ligne et colonne

Pour pouvoir comparer les zones, chaque groupe est ramené à une même base
égale à 100.

```{r}
freqLg <- round(prop.table(table(data$NOM_IRIS, data$taille), margin = 1)*100,0)
knitr::kable(freqLg, title = "Fréquence conditionnelle ligne")
```


savoir-faire tableur

- Objectif : saisir une seule cellule et étendre la formule.
quelle élément fixer, ligne ou colonne ?

- utilisation du %

![](img/frequenceLG.png)

analyse

- répartition des types d'appartement puis lorsque ramené à une base 100, on peut comparer entre les zones.

- les écarts à la moyenne par type d'appartements sont plus parlants

![](img/graphEcartFreqLg.png)

Qu'apporterait une étude des fréquences conditionnelles en colonnes ?

## Correction du quizz sur les tableaux de contingence de l'année dernière


### Données

#### Mauvaise réponse

* Il y a 3 variables : les lits de réanimation, les lits intensifs et les lits de surveillance, tout cela par région*


#### Bonne réponse

* Les lits par région *

#### Très bonne réponse


* Il y a 2 variables : les régions et le type de lit (réanimation, surveillance et intensif)
Ces deux données sont de type catégorie.*

### Hypothèse


#### Mauvaise réponse

* Il serait logique que chaque région ait une capacité adaptée à sa population*

Il n'y a pas de variable population dans les données donc pas d'hypothèse autour de la population.

#### Bonne réponse


* Les répartitions de type de lit ne sont pas les mêmes entre les régions*

### Fréquences conditionnelles en ligne

#### Mauvaise réponse

* On peut voir sur la même base qui est 100 la différence pour les 3 données pour une seule région*


Il manque des exemples précis.

#### Bonne réponse

* Les régions ont une plus forte proportion de lits de surveillance que des autres types de lit (42 % en moyenne). 
Les lits intensifs et de réanimation sont en part égales.
Mais il y a des différences entre les régions. Par exemple, la Bretagne compte beaucoup de lits de réanimation. A l'inverse, l'Ile de France en a peu.
La PAC et le centre val de Loire ont moins de lits de surveillance.
Donc les répartitions sont différentes entre région.*



### Fréquences conditionnelles en colonne

La bonne réponse était qu'il n'est pas nécessaire de l'étudier.
En effet, la répartition des lits de réanimation entre les différentes régions ne fait que réfléter l'effectif de la population de chaque région.
Or, nous n'avons pas cette variable dans le tableau.

# Effectifs théoriques et observées

## Analogie du jeu du dé ou test de conformité

Le dé est-il truqué ?

```{r}
face <- seq(1,6)
effectif <- c(15,7,4,11, 6, 17)
total <-  sum(effectif)
knitr::kable(data.frame(face,effectif))
```

Le nombre total de lancers est de 60.

### Hypothèse d'indépendance

hypothèse H0 : le dé n'est pas truqué (il y a indépendance entre la face et le
nombre de fois où elle sort)

### Effectifs théoriques

Sur le total des lancers (60), chaque face aurait pû sortir 10 fois.

```{r}
effectifThéorique <- rep (10,6)
df <- data.frame(face, effectif, effectifThéorique)
knitr::kable(df)
```

### Calcul du khi2

distance entre effectifs théoriques et observés

Elle se mesure avec le khi2

On calcule l'écart, puis le carré de cet écart et on pondère par l'effectif théorique.

```{r}
(ecart <- df$effectif - df$effectifThéorique)
(distance <-  ecart^2)
(relatif <- distance / df$effectifThéorique)
(khi2 <- sum(relatif))
```

### Test du khi2

#### Paramètres du test

- degré de liberté : 5

C'est le nombre de valeurs possibles -1 (car on peut déterminer la 6e valeur à partir des 5 autres)

- Pour un risque à 0,05 (5 chances sur 100 de se tromper)

### Résultat

Lecture dans la table du khi2

![](img/khi2table.png)
le khi2 théorique est de 11,7, il est donc inférieur au khi2 observé.

Quand le khi2 théorique est inférieur, le test est rejeté.

Le test est rejeté avec un risque de 5 %

Donc, le dé est truqué.

## Sur notre série

### Ennoncer l'hypothèse H0

Le type d'appartement est indépendant quartier.

### Effectif théorique

La première case reçoit la formule :

- (total lg / total) * total colonne

C'est ce qu'on appelle également le produit des marges

![](img/effectifTheorique.png)



### Ecarts entre observés et théoriques

Que signifie une valeur zéro ?

Utiliser la notion

- sur représentation / sous représentation


![](img/ecartsTableauComplet.png)

Les petits appartements sont sous-représentés à Blanqui et à la remise à Jorelle par rapport à une distribution identique entre les quartiers.


### Le Khi2 

Le khi2 va permettre de valider le rejet de l'hypothèse d'indépendance.

rappel : métrique euclidienne plutôt que les valeurs absolues on utilise les carrés


#### Le Khi2 partiel

On met les écarts rapportés à la valeur théorique d'indépendance au carré.
Puis on divise par l'effectif théorique.



![](img/khi2partiel.png)

#### Le Khi2


Le total de tous les khi2 partiels

![](img/khi2partiel2.png)



```{r}
data <- read.csv("data/rplsPieceZone.csv")
tab <- table(data$NOM_IRIS, data$taille)
chisq.test(tab)
```


C'est le total des khi2 partiels (dans notre exemple 338)

On définit :

- degré de liberté
lg -1 * col -1

8 zone et 3 types d'appartements = 7 * 2 = 14


- risque 1, 5 et 10 %

Sur internet, dans n'importe quelle table, on cherche les valeurs correspondantes.

#### Rejet de H0 ou pas


![](img/test.png)

HO hypothèse d'indépendance. son rejet implique qu'il y a une relation.

Les variables nombre de pièces et zones ont une relation avec une marge d'erreur très faible puisque le khi2 augmente avec le risque d'erreur.

### Intensité de la liaison

indicateur entre 0 et 1. 1 pour très forte intensité.


#### Coefficient de contingence

Le plus simple est le coefficient de contingence peut mesurer cette relation.

C'est le Khi2 rapporté à la somme Khi2 et de l'effectif total


#### Coefficient de Tschuprow

D'autres coefficients permet de reprendre le nombre de degrés de liberté et ainsi de s'affranchir de la taille du tableau.

Celui de Tschuprow est le khi2 calculé rapporté à l'effectif total multiplié par la racine carré du nombre de degré de liberté.

![](img/coeff.png)



### Interprétation des coefficients

Ils sont très faibles, donc même si les variables sont dépendantes l'une de l'autre, l'intensité de la relation est faible.

# Correction du quizz

## Ecarts entre observés et théoriques

Penser à utiliser les terme attraction / répulsion ou sur et sous représentation.


### Bonne réponse



Sera bonne toute réponse commentant le graphique.

#### exemple

* Il y a par exemple, une sur représentation du nombre de lits intensifs dans les régions PACA et Centre Val de Loire ainsi qu'une anomalie sur le nombre de lits en Bretagne *

Bien, mais je me demande de quelle anomalie il s'agit. Si je dois aller voir le graphique pour la comprendre, ce n'est pas bon.

#### Meilleur exemple


* En PACA, les lits de surveillance sont sous représentés tandis qu'en Ile de France, ils sont sur représentés *

* La région PACA est répulsive pour les lits de surveillance au contraire de l'Ile de France*

## Rejet de l'hypothèse

* On constate que le khi2 calculé est supérieur au khi2 théorique donc nous ne sommes pas dans une situation de hasard *

## Intensité de la relation

* Elle existe mais elle est très faible (Proche de 0 ; 0.018)*






