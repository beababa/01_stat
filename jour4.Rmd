---
title: "Statistiques bi variées - Regression"
output:
  html_document:
    number_sections: yes
    toc: yes
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# Données d'exemple

On travaille à présent sur les suffrages exprimés et l'abstention.

Comprendre les variables

Enoncer les hypothèses possibles de la comparaison, attention variable explicative (X) et à expliquer (Y)

(cf moodle exercice *Introduction =régression*)


```{r}
data <- read.csv("data/bondy2022.csv", fileEncoding = "UTF-8", dec =".")
ind <- grep("X..Voix.Exp",names(data))
ind <- c(ind, 8,10)
data <- data [, c(ind)] 
write.csv(data, "data/abs2022.csv")
```

# Nuage de points

## Quel candidat choisir ?

```{r, echo=F}
data <- read.csv("data/abs2022.csv", dec = ",")
i <- 1
par(mfrow = c(3,4))
for (i in 2:13){
  candidats <- c("ARTHAUD",	"ROUSSEL",	"MACRON",	"LASSALLE",	"LE PEN",	"ZEMMOUR",	"MÉLENCHON",
                 "HIDALGO",	"JADOT",	"PÉCRESSE",	"POUTOU",	"DUPONT-AIGNAN")

  plot(data$Abstentions, data [,i], xlab = "nb abst", ylab = "nb voix", main = candidats [i-1] )
}
```


variable explicative et expliquée.

```{r}
names(data) <- c("lg", candidats, "bv", "abstentions")
write.csv (data, "data/abstentions2022VF.csv")
```


## Savoirs faire tableur

- sélectionner uniquement les 2 colonnes de données

- types de diagramme ; xy - dispersion

- intervertir x et y (onglet série de données) 

![](img/inversionxy.jpg)


## Simplification des chiffres

### Redéfinition des bornes

Retour sur les distributions pour enlever les valeurs aberrantes

```{r}
hist(data$abstentions)
hist(data$ZEMMOUR)
```

On recherche des bornes permettant d'avoir un nuage de points "cohérent".
Avec le tableur, on fait le graphique puis on ajuste avec le filtre.

```{r}
sel <- data [data$abstentions %in% c(150:330) ,]
sel <- sel [sel$ZEMMOUR > 2,]
plot(sel$abstentions, sel$ZEMMOUR)
```



# Droite de régression

La droite de régression minimise la somme des carrés des distances verticales entre chacun des points du nuage et la droite recherchée.

Pour une droite aX+b

- a (la pente) = covariance / variance X

- b (ordonnée de l'origine) = moyenne de Y - a * moyenne de X

![](img/regression.jpg)
La distance MP doit être minimale d'où le terme *droite des moindres carrées*


```{r}
plot(data$abstentions, data$ZEMMOUR)
# modèle de régression
lm <- lm(data$ZEMMOUR~data$abstentions)
abline(lm, lty =2, lwd = 1, col = "red")
text( data$abstentions, data$ZEMMOUR,labels = as.character(data$bv))
```


Dans calc, cliquer sur les points et insérer courbe de tendance
(on peut également afficher l'équation de la droite.)

Visuellement, on voit bien qu'il existe un lien entre les deux variables, mais la pente de la droite n'est pas très forte. 

Il s'agit maintenant de mesurer précisemment l'intensité du lien à l'aide de calculs.

# Intensité du lien : covariance et coefficient de Bravais-Pearson

Savoir-faire tableur : utiliser les noms pour les colonnes


### Premier temps

On rajoute des colonnes pour chaque variable :

- écart à la moyenne

- carré ( = *distance* plutôt que *différence*)

et pour les deux variables

- produit des écarts (pour étudier le rapport entre 2 variables, techniquement on utilise une division ou une multiplication)

### Deuxième temps

Dans un nouveau tableau, pour chaque variable

- moyenne

- carré de la somme des écarts à la moyenne 

- Variance

- Ecart type

puis covariance (produit des écarts / nb de valeurs)

et coeff (cov / produit des écarts types)


![](img/formules.png)

![](img/resultat.png)

### Interprétation

Le coefficient évolue de -1 à +1

- Si r = 0, les variables ne sont pas corrélées.

- Dans les autres cas, les variables sont corrélées négativement ou positivement.


- plus la variable est proche de 1, plus l'intensité de la relation entre les deux variables est forte.

Dans notre exemple, lien faible

```{r}
varCorr <- data [, c( "abstentions", "ZEMMOUR")]
cor(varCorr)
```



# Coefficient de détermination

C'est le carré du coefficient de corrélation linéaire

```{r}
cor(varCorr)^2
```


L'abstention explique 31 % du vote pour le candidat 6.

Les 69 % restant sont liés à d'autres facteurs.

# Etude des résidus

![](img/moindreCarre.jpg)


Identifiez graphiquement 2 points éloignés de la droite de régression et tenter un 
commentaire.


![](img/residu.jpg)
# cartographie des résidus


```{r}
library(sf)
bv <- st_read("data/vote.gpkg", "bureauPolyZone")
```




```{r}
library(sf)
library(mapsf)
residus <- rstudent(lm)
hist(residus)
# on calcule les résidus
data <- cbind(bv, residus)
dataResidu <- data [data$residus < -1 | data$residus > + 1, drop = F]
```

```{r}
mf_map(data, var = "residus", type="choro", breaks = c(-3, -2,0,2,3), pal = terrain.colors(4))
mf_label(bv, var = "numBureau", overlap = FALSE, col= "white",bg ="black", halo = T, cex = 0.8)
mf_layout("ZEMMOUR et abstention : étude des résidus", credits = "Ministère de l'intérieur; 2022")
```


